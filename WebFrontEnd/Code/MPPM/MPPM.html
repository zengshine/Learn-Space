<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="../../Scripts/jquery-3.3.1.min.js"></script>
</head>

<body>
    <section>
        <p>
            <input id="authorizationTest" value="认证测试" type="button" />
        </p>
        <p>
            <input id="getminiprogramID" value="获取小程序" type="button" />
        </p>
        <p>
            <input type="number" id="mpStateNum" />
            <input id="MPProcess" value="流程" type="button" />
        </p>
        <p>
            <input type="text" id="mpModifyValue" />
            <input id="mpModifyBtn" value="更改" type="button" />
        </p>
        <p>
            <input id="fileUplod" type="file" />
            <input id="fileUplodBtn" value="文件上传" type="button" />
        </p>
        <p>
            <input id="downloadFile" value="文件下载" type="button" />
        </p>
        <img width="200px" src="/UpFiles/Attachments/filter.jpg" />
    </section>
    <script>
        document.getElementById("authorizationTest").addEventListener("click", authHandler);
        var CurUser = {
            USID: "",
            NAME: ""
        }
        var MPList = []
        //登录验证
        function authHandler(evt) {
            var ticket =
                "BA10B0BE59C10D0BD2941F050B985B8BCDEE940586D29F94632BFDFB7B164F857A08EB4A26DB6B241E56EE9DACCE9BBA754FAAB08783C7DA519BF05E702E23CC07D7CCF2562599D43B9DA217146BD83E2A345D588E83E415679AFD0C5D9234F9AF8CFEA2400BC15C850D7365F896B85908DEE75404FF6F48CE8316F9CF2E7EB78D920D0271572978987B4C060E5330EA7343F7D18746371D9F0ADD034B6C5DD5CF8BF261AE485DA9E71048AEB71559A0BAEFA85348613F4AF00C8840F102E1BEF784F66D667FA9A33A827F2B4116EC878F68224173AD0802DE497D7C6E11561E"
            var data =
                'VVNJRD0yMzQ4NDZ8T1JHSUQ9MTIyMDM1fFRJTUU9MjAxOC0wMS0xMlQxMTo0NDo1NXxJUD05OS4xMi40My4xMjd8U0FQSUQ9ODAyMzQ4NDZ8RU1BSUw9a2Fyc29uNzE4QGNtYmNoaW5hLmNvbXxOQU1FPcDuv7XPzXxCUjE9MTAwMDAzfFBBVEg919zQ0C%2fQxc%2bivLzK9bK%2fL9XQ0vjN%2bMLnv8a8vC%2fR0Lei1tDQxC%2fH%2frXA0rXO8b%2bqt6LNxbbTL7DsuavX1Lavu6%2fSu8rSo6jJ7tvao6l8R1BJRD0wMTAwMDQ1OFM5'
            var token =
                'kH5r7BXhcd1q3jgIe2ZPQWEnaAzZb6n8t%2f67D9GIBAcBtL1sP6JCyFz3bAxCHkHwLJTPuyPCHZmXuDCAtSQX%2bJsP1uajVuLangUhbERy9kLB%2fZgUjxZAmpN3i3HrKH9gKlsUzpjkGyt%2bjp8%2fcNB7T578brs8BpwXRnMglE3G5ng%3d'
            //var data ='eyJ5c3RJRCI6IjE5ODcwNyIsInNhcElEIjoiMDEwNDA2MzQiLCJuYW1lIjoi55m96Z2Z5p2wIiwib3JnSUQiOiIxMTA0MjIiLCJvcmdOYW1lIjoi6L%2BQ6KGM6LCD5bqm5a6kIiwicGF0aElEIjoiLzEwMDAwMy8xMDAxNDMvMTEzNDAyLzExMDQyMiIsInBhdGhOYW1lIjoi5oC76KGML%2BS%2FoeaBr%2BaKgOacr%2BmDqC%2FmlbDmja7kuK3lv4Mv6L%2BQ6KGM6LCD5bqm5a6kIiwicGxhdGZvcm0iOiJhbnBob25lIiwib3NWZXJzaW9uIjoiNy4wIiwicHViVmVyc2lvbiI6IlYyLjMuOSIsImRldmljZUlEIjoiNzE5NDE0MzItOEEwRC00MDk4LTlERTUtNzg4MjUxMEUxMzQ0IiwidGltZSI6IjIwMTctMTItMjRUMDk6NDQ6MDYifQ%3D%3D'
            //var token ='a35b823e0b002a14c78c012b70254a6ff9e21f3467ea11d4563be605bfd534e7850264c45a145cdb0ac287f655cd5117284a6abffbd0d8bb5f3cfad0c37211ac82bd868fe8d3e9aae671ec7147cc2ac5481dbe3bf3db5690bedd727f6254f0a9d922e62d9431594616aebc3964537851bee58580b38bb48d15225ab3e1b576de'
            var formData = new FormData();
            formData.append("data", data.replace(/\s/g, ""));
            formData.append("token", token.replace(/\s/g, ""));
            $.ajax({
                url: "/api/users?isTokenExpired=true",
                type: 'Post',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'BasicAuth ' + ticket)
                },
                data: formData,
                contentType: false,
                processData: false,
                success: function (result) {
                    if (result.StateCode) {
                        CurUser = result.Data;
                        authTest(result.Data.TICKET)
                        console.log("登录认证成功")
                    } else {
                        console.log("登录认证失败")
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log("调用登录认证接口失败")
                },
                cache: false,
                dataType: 'json'
            });
        }
        authHandler()
        //验证测试
        function authTest(ticket) {
            $.ajax({
                url: "/api/values",
                type: 'Get',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'BasicAuth ' + ticket)
                },
                success: function (result) {
                    console.log("认证通过")
                    getMiniPrograms();
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log("认证失败")
                },
                cache: false,
                dataType: 'json'
            });
        }
        document.getElementById("getminiprogramID").addEventListener("click", getMiniPrograms)
        //获取小程序
        function getMiniPrograms() {
            $.ajax({
                url: "/api/miniprogram?userId=" + CurUser.USID,
                type: 'Get',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'BasicAuth ' + CurUser.TICKET)
                },
                success: function (result) {
                    MPList = result.Data.MPList;
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log("err")
                },
                cache: false,
                dataType: 'json'
            });
        }
        //创建小程序接口测试
        document.getElementById("MPProcess").addEventListener("click", setup);

        function setup(ticket) {
            var state = document.getElementById("mpStateNum").value
            miniProgram = MPList[2]
            miniProgram.CurrStateNo = state;
            var formData = new FormData()
            formData.append("MiniProgram", JSON.stringify(miniProgram))
            formData.append("CurUser", JSON.stringify(CurUser))
            $.ajax({
                url: "/api/miniprogram",
                type: 'Post',
                data: formData,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'BasicAuth ' + CurUser.TICKET)
                },
                contentType: false,
                processData: false,
                success: function (result) {
                    console.log(result)
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log("err")
                },
                cache: false,
                dataType: 'json'
            });
        }

        document.getElementById("mpModifyBtn").addEventListener("click", modifyMP)
        //修改小程序接口
        function modifyMP() {
            var MPName = document.getElementById("mpModifyValue").value
            miniProgram = MPList[2]
            miniProgram.PApplyFullName = MPName;
            var formData = new FormData()
            formData.append("MiniProgram", JSON.stringify(miniProgram))
            formData.append("CurUser", JSON.stringify(CurUser))
            $.ajax({
                url: "/api/miniprogram",
                type: 'Put',
                data: formData,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'BasicAuth ' + CurUser.TICKET)
                },
                contentType: false,
                processData: false,
                success: function (result) {
                    console.log(result)
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log("err")
                },
                cache: false,
                dataType: 'json'
            });
        }
        //文件上传
        document.getElementById("fileUplod").addEventListener("change", function (evt) {
            var file = evt;
            miniProgram = MPList[2]
            var formData = new FormData()
            var fieldName="SAttachId";
            formData.append("MPID", miniProgram.Id)
            formData.append("FieldID", miniProgram[fieldName])
            formData.append("fieldName", fieldName)
            formData.append("file", this.files[0])
            $.ajax({
                url: "/api/files",
                type: 'Post',
                data: formData,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'BasicAuth ' + CurUser.TICKET)
                },
                contentType: false,
                processData: false,
                success: function (result) {
                    var data = result.data;
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log("图片上传失败")
                },
                cache: false,
                dataType: 'json'
            });
        });
        //下载文件
        document.getElementById("downloadFile").addEventListener("click",downloadFile)
         function downloadFile(evt) {
            location.href=location.origin+"/api/files?path=/UpFiles/Attachments/家庭活动日.xlsx"
            }
    </script>
    <script>
        var formData = new FormData();
        formData.append("CurrStateNo", 11)
        formData.append("IsAdminUpdate", false)
        formData.append("PApplyFullName", "name")
        formData.append("PApplyFirstName", "firstName")
        formData.append("PMerchantName", "PMerchantName")
        formData.append("PBranchName", "PBranchName")
        formData.append("PMerchantType", "PMerchantType")
        formData.append("PDesc", "PDesc")
        formData.append("PUserName", "PUserName")
        formData.append("PUserBranch", "PUserBranch")
        formData.append("CreateUserNo", "CreateUserNo123")
        formData.append("CreateUserName", "CreateUserName")
        var miniProgram = {
            CurrStateNo: 11,
            IsAdminUpdate: false,
            PApplyFullName: "PApplyFullName",
            PApplyFirstName: "PApplyFirstName",
            PMerchantName: "PMerchantName",
            PMerchantType: "PMerchantType",
            PBranchName: "PBranchName",
            PUserName: CurUser.NAME,
            PUserNo: CurUser.USID,
            PUserBranch: "PUserBranch",
            CreateUserNo: "CreateUserNo",
            CreateUserName: "CreateUserName",
        }
    </script>
</body>

</html>